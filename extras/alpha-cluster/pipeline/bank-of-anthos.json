{"source":2,"revision":5,"description":null,"createdBy":{"displayName":"Sergio Hinojosa Jimenez","url":"https://spsprodweu3.vssps.visualstudio.com/Ab3bf8268-3954-45ca-a8ea-6dc9b29d125f/_apis/Identities/7e62c20d-31cc-487b-aff1-9a1bceab6e63","_links":{"avatar":{"href":"https://dev.azure.com/dynatracedevops/_apis/GraphProfile/MemberAvatars/aad.NDU0NmM2ODYtZWVhOC03Yzg2LTkyODQtZTBhZWVmNDZlN2M5"}},"id":"7e62c20d-31cc-487b-aff1-9a1bceab6e63","uniqueName":"sergio.hinojosa@dynatrace.com","imageUrl":"https://dev.azure.com/dynatracedevops/_apis/GraphProfile/MemberAvatars/aad.NDU0NmM2ODYtZWVhOC03Yzg2LTkyODQtZTBhZWVmNDZlN2M5","descriptor":"aad.NDU0NmM2ODYtZWVhOC03Yzg2LTkyODQtZTBhZWVmNDZlN2M5"},"createdOn":"2024-10-03T15:38:55.700Z","modifiedBy":{"displayName":"Sergio Hinojosa Jimenez","url":"https://spsprodweu3.vssps.visualstudio.com/Ab3bf8268-3954-45ca-a8ea-6dc9b29d125f/_apis/Identities/7e62c20d-31cc-487b-aff1-9a1bceab6e63","_links":{"avatar":{"href":"https://dev.azure.com/dynatracedevops/_apis/GraphProfile/MemberAvatars/aad.NDU0NmM2ODYtZWVhOC03Yzg2LTkyODQtZTBhZWVmNDZlN2M5"}},"id":"7e62c20d-31cc-487b-aff1-9a1bceab6e63","uniqueName":"sergio.hinojosa@dynatrace.com","imageUrl":"https://dev.azure.com/dynatracedevops/_apis/GraphProfile/MemberAvatars/aad.NDU0NmM2ODYtZWVhOC03Yzg2LTkyODQtZTBhZWVmNDZlN2M5","descriptor":"aad.NDU0NmM2ODYtZWVhOC03Yzg2LTkyODQtZTBhZWVmNDZlN2M5"},"modifiedOn":"2024-10-09T17:59:13.263Z","isDeleted":false,"isDisabled":false,"lastRelease":{"id":8751,"name":"Release-1601","artifacts":[],"_links":{},"description":"Scheduled release for pipeline 'bank-of-anthos'.","releaseDefinition":{"id":4,"projectReference":null,"_links":{}},"createdOn":"2024-12-10T11:00:03.943Z","createdBy":{"displayName":"[dynatracedevops]\\Project Collection Service Accounts","url":"https://spsprodweu3.vssps.visualstudio.com/Ab3bf8268-3954-45ca-a8ea-6dc9b29d125f/_apis/Identities/b7c9ea6f-d7d7-48d7-a5a7-6b3be9ffa804","_links":{"avatar":{"href":"https://dev.azure.com/dynatracedevops/_apis/GraphProfile/MemberAvatars/vssgp.Uy0xLTktMTU1MTM3NDI0NS04MjAwNDI1MjMtMzYzMjgxMTU5Ny0yNTE0MDMyNzgyLTEzMTM2MjIyMC0wLTAtMC0wLTI"}},"id":"b7c9ea6f-d7d7-48d7-a5a7-6b3be9ffa804","uniqueName":"vstfs:///Framework/IdentityDomain/1bdbe030-88d8-4d4e-95d9-188e07d46dac\\Project Collection Service Accounts","imageUrl":"https://dev.azure.com/dynatracedevops/_apis/GraphProfile/MemberAvatars/vssgp.Uy0xLTktMTU1MTM3NDI0NS04MjAwNDI1MjMtMzYzMjgxMTU5Ny0yNTE0MDMyNzgyLTEzMTM2MjIyMC0wLTAtMC0wLTI","isContainer":true,"descriptor":"vssgp.Uy0xLTktMTU1MTM3NDI0NS04MjAwNDI1MjMtMzYzMjgxMTU5Ny0yNTE0MDMyNzgyLTEzMTM2MjIyMC0wLTAtMC0wLTI"}},"variables":{"dt_clientid":{"value":null,"isSecret":true},"dt_clientsecret":{"value":null,"isSecret":true},"dt_event_wf":{"value":"191e4360-1a51-41dc-9bfb-35112daafca8"},"dt_tenant_url":{"value":"https://sro97894.apps.dynatrace.com"},"dt_validation_wf_id_production":{"value":"2cabc0f1-bc71-4bed-b51b-c3915b7cdd26"},"dt_validation_wf_id_staging":{"value":"5d8d9a97-2a2a-4665-b96e-845cd2900b42"},"DYNATRACE_API_TOKEN":{"value":null,"isSecret":true},"DYNATRACE_API_URL":{"value":"https://sro97894.live.dynatrace.com/api/v2/events/ingest"},"ENVIRONMENT":{"value":"staging"},"LOOPS":{"value":"30"},"PRODUCTION_NAMESPACE":{"value":"production-banking"},"SERVER_URL":{"value":"staging.banking.whydevslovedynatrace.com"},"STAGING_NAMESPACE":{"value":"staging-banking"},"VERSION":{"value":""},"VU":{"value":"10"}},"variableGroups":[],"environments":[{"id":5,"name":"Staging","rank":1,"owner":{"displayName":"Sergio Hinojosa Jimenez","url":"https://spsprodweu3.vssps.visualstudio.com/Ab3bf8268-3954-45ca-a8ea-6dc9b29d125f/_apis/Identities/7e62c20d-31cc-487b-aff1-9a1bceab6e63","_links":{"avatar":{"href":"https://dev.azure.com/dynatracedevops/_apis/GraphProfile/MemberAvatars/aad.NDU0NmM2ODYtZWVhOC03Yzg2LTkyODQtZTBhZWVmNDZlN2M5"}},"id":"7e62c20d-31cc-487b-aff1-9a1bceab6e63","uniqueName":"sergio.hinojosa@dynatrace.com","imageUrl":"https://dev.azure.com/dynatracedevops/_apis/GraphProfile/MemberAvatars/aad.NDU0NmM2ODYtZWVhOC03Yzg2LTkyODQtZTBhZWVmNDZlN2M5","descriptor":"aad.NDU0NmM2ODYtZWVhOC03Yzg2LTkyODQtZTBhZWVmNDZlN2M5"},"variables":{},"variableGroups":[],"preDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":18}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":1}},"deployStep":{"id":19},"postDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":22}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":2}},"deployPhases":[{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"agentSpecification":null,"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[{"alias":"bank-of-anthos","artifactType":"GitHub","artifactDownloadMode":"All","artifactItems":[]}]},"queueId":71,"demands":[],"enableAccessToken":true,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":1,"phaseType":1,"name":"staging-deployment","refName":null,"workflowTasks":[{"environment":{"DT_CLIENT_ID":"$(dt_clientid)","DT_CLIENT_SECRET":"$(dt_clientsecret)"},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Rollout Kubernetes Deployments","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":10,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"filePath","filePath":"$(System.DefaultWorkingDirectory)/bank-of-anthos/extras/azdo-integration/agent_do_rollout.sh","arguments":"-e $(ENVIRONMENT) -d yes","script":"#!/bin/bash\n\n\ncd $(System.ArtifactsDirectory)/$(Release.PrimaryArtifactSourceAlias)\n\ncalculateDeployment() {\n    #Date in 12 Hour format (01-12)\n    h=$(date +\"%I\")\n    echo \"H is $h\"\n    case $h in\n    \"12\" | \"06\")\n        Deployment_memory_problem\n        ;;\n    \"01\" | \"07\")\n        Deployment_latest\n        ;;\n    \"02\" | \"08\")\n        Deployment_memory_problem\n        ;;\n    \"03\" | \"09\")\n        Deployment_latest\n        ;;\n    \"04\" | \"10\")\n        Deployment_memory_problem\n        ;;\n    \"05\" | \"11\")\n        Deployment_latest\n        ;;\n    esac\n}\n\nDeployment_latest() {\ncd $(System.ArtifactsDirectory)/$(Release.PrimaryArtifactSourceAlias)\nkubectl set image -n $(staging_namespace) deployment/transactionhistory transactionhistory=gcr.io/sales-engineering-emea/bank-of-anthos/transactionhistory:latest\nkubectl rollout restart deployment/transactionhistory -n $(staging_namespace)\nkubectl wait --for=condition=available --timeout=300s --all deployments --namespace $(staging_namespace)  || true\n#kubectl delete deployment loadgenerator -n $(staging_namespace) || true\n}\n\nDeployment_memory_problem() {\nkubectl set image -n $(staging_namespace) deployment/transactionhistory transactionhistory=gcr.io/sales-engineering-emea/bank-of-anthos/transactionhistory:memory-dtsaas\nkubectl rollout restart deployment/transactionhistory -n $(staging_namespace)\nkubectl wait --for=condition=available --timeout=300s --all deployments --namespace $(staging_namespace)  || true\n#kubectl delete deployment loadgenerator -n $(staging_namespace) || true\n}\n\n#Deployment_latest\n#Deployment_memory_problem\ncalculateDeployment","workingDirectory":"","failOnStderr":"false","bashEnvValue":""}},{"environment":{},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Send Deployment and Test Event to Dynatrace","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":10,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"$(System.DefaultWorkingDirectory)/bank-of-anthos/extras/azdo-integration/agent_do_rollout.sh","arguments":"-e $(ENVIRONMENT) -d yes $(dt_event_wf) $(dt_tenant_url)","script":"#!/bin/bash\n\ncreate_token()\n{\nresult=$(curl --request POST 'https://sso.dynatrace.com/sso/oauth2/token' \\\n--header 'Content-Type: application/x-www-form-urlencoded' \\\n--data-urlencode 'grant_type=client_credentials' \\\n--data-urlencode \"client_id=$(dt_clientid)\" \\\n--data-urlencode \"client_secret=$(dt_clientsecret)\" \\\n--data-urlencode 'scope=document:documents:write document:documents:read document:documents:delete document:environment-shares:read document:environment-shares:write document:environment-shares:claim document:environment-shares:delete automation:workflows:read automation:workflows:write automation:workflows:run automation:rules:read automation:rules:write automation:calendars:read automation:calendars:write')\nresult_dyna=$(echo $result | jq -r '.access_token')\n}\n\nget_wf_status()\n{\ncreate_token\ncurl -X 'GET' \\\n  \"$(dt_tenant_url)/platform/automation/v1/executions/$(echo $id)\" \\\n  -H 'accept: application/json' \\\n  -H 'Content-Type: application/json' \\\n  -H \"authorization: Bearer $(echo $result_dyna)\" | jq -r '.state'\n}\n\nstart_event_wf()\n{\ncreate_token\nres=$(curl -X 'POST' \\\n  \"$(dt_tenant_url)/platform/automation/v1/workflows/$(dt_event_wf)/run\" \\\n  -H 'accept: application/json' \\\n  -H 'Content-Type: application/json' \\\n  -H \"authorization: Bearer $(echo $result_dyna)\" \\\n  -d '{\n         \"params\": {\n            \"event_type\": \"CUSTOM_DEPLOYMENT\",\n            \"PROBLEM\": \"$(PROBLEM)\",\n            \"Release\": $(Release.ReleaseId),\n            \"Pipelineurl\": \"$(Release.ReleaseWebURL)\",\n            \"stage\": \"$(ENVIRONMENT)\",\n            \"Repository\": \"$(REPOSITORY)\",\n            \"Release_Version\": \"$(DT_RELEASE_VERSION)\",\n            \"Application\": \"$(APPLICATION)\",\n            \"Namespace\": \"$(NAMESPACE)\",\n            \"Build_Version\": \"$(DT_RELEASE_BUILD_VERSION)\"            \n         }\n         }')\nid=$(echo $res | jq -r '.id')\necho $id\nwhile [[ $(get_wf_status) == \"RUNNING\" ]]; do\nsleep 10\ndone\n\n}\n\nstart_test_wf()\n{\ncreate_token\nres=$(curl -X 'POST' \\\n  \"$(dt_tenant_url)/platform/automation/v1/workflows/$(dt_event_wf)/run\" \\\n  -H 'accept: application/json' \\\n  -H 'Content-Type: application/json' \\\n  -H \"authorization: Bearer $(echo $result_dyna)\" \\\n  -d '{\n         \"params\": {\n            \"event_type\": \"START_TEST\",\n           \"PROBLEM\": \"$(PROBLEM)\",\n            \"Release\": $(Release.ReleaseId),\n            \"Pipelineurl\": \"$(Release.ReleaseWebURL)\",\n            \"stage\": \"$(ENVIRONMENT)\",\n            \"Repository\": \"$(REPOSITORY)\",\n            \"Release_Version\": \"$(DT_RELEASE_VERSION)\",\n            \"Application\": \"$(APPLICATION)\",\n            \"Namespace\": \"$(NAMESPACE)\",\n            \"Build_Version\": \"$(DT_RELEASE_BUILD_VERSION)\"            \n         }\n         }')\nid=$(echo $res | jq -r '.id')\necho $id\nwhile [[ $(get_wf_status) == \"RUNNING\" ]]; do\nsleep 10\ndone\n\n}\n\n\nsend_deployment_event()\n{\n  start_event_wf\n  start_test_wf\n}\n\n\n\nsend_deployment_event\n","workingDirectory":"","failOnStderr":"false","bashEnvValue":""}},{"environment":{"$dt_clientid":"$(dt_clientid)","$dt_clientsecret":"$(dt_clientsecret)","$dt_tenant_url":"$(dt_tenant_url)","$dt_validation_wf_id":"$(dt_validation_wf_id)"},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Start Performance Test","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":20,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"filePath","filePath":"$(System.DefaultWorkingDirectory)/bank-of-anthos/extras/azdo-integration/agent_start_loadtest.sh","arguments":"","script":"#!/bin/bash\nstart_performance_test() {\ncd $(System.ArtifactsDirectory)/$(Release.PrimaryArtifactSourceAlias)/extras/jmeter\n#SERVER_URL=$(kubectl get service frontend -n $(staging_namespace) | awk '{print $4}')\necho $(SERVER_URL)\necho\n# using default for now\n/home/daniel_braaf/jmeter/apache-jmeter-5.5/bin/jmeter -SERVER_URL=$SERVER_URL -JVUCount=10  -JLoopCount=30 -n -t Test_Banking_Process.jmx -l testreport.jtl  \n}\n\nstart_timestamp=$(date '+%F %H:%M:00')\necho $start_timestamp\necho \"##vso[task.setvariable variable=start_timestamp]$start_timestamp\"\nstart_performance_test\nstop_timestamp=$(date '+%F %H:%M:00')\necho $stop_timestamp\necho \"##vso[task.setvariable variable=stop_timestamp]$stop_timestamp\"\n\n","workingDirectory":"","failOnStderr":"false","bashEnvValue":""}},{"environment":{"$dt_clientid":"$(dt_clientid)","$dt_clientsecret":"$(dt_clientsecret)","$dt_tenant_url":"$(dt_tenant_url)","$dt_validation_wf_id":"$(dt_validation_wf_id)"},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Dynatrace Release Validation","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":10,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"#!/bin/bash\n\necho \"check variables from last step\"\nenv\necho \"start reading functions\"\n\ncreate_token()\n{\nresult=$(curl --request POST 'https://sso.dynatrace.com/sso/oauth2/token' \\\n--header 'Content-Type: application/x-www-form-urlencoded' \\\n--data-urlencode 'grant_type=client_credentials' \\\n--data-urlencode \"client_id=$(dt_clientid)\" \\\n--data-urlencode \"client_secret=$(dt_clientsecret)\" \\\n--data-urlencode 'scope=document:documents:write document:documents:read document:documents:delete document:environment-shares:read document:environment-shares:write document:environment-shares:claim document:environment-shares:delete automation:workflows:read automation:workflows:write automation:workflows:run automation:rules:read automation:rules:write automation:calendars:read automation:calendars:write')\nresult_dyna=$(echo $result | jq -r '.access_token')\n#echo \"created Token\"\n#echo $result_dyna\n}\n\nget_validation_status()\n{\ncreate_token\ncurl -X 'GET' \\\n  \"$(dt_tenant_url)/platform/automation/v1/executions/$(echo $id)\" \\\n  -H 'accept: application/json' \\\n  -H 'Content-Type: application/json' \\\n  -H \"authorization: Bearer $(echo $result_dyna)\" | jq -r '.state'\n}\n\nget_result()\n{\ncreate_token\nrex=$(curl -X 'GET' \\\n  \"$(dt_tenant_url)/platform/automation/v1/executions/$(echo $id)/tasks\" \\\n  -H 'accept: application/json' \\\n  -H 'Content-Type: application/json' \\\n  -H \"authorization: Bearer $(echo $result_dyna)\") \n#echo $rex\nvalidationresult=$(echo $rex | jq -r '.run_validation.result.validation_status')\nvalidationurl=$(echo $rex | jq -r '.run_validation.result.validation_url')\njira=$(echo $rex | jq -r '.create_tracking_task.result.key')\njiraurl=$(echo $rex | jq -r '.create_tracking_task.result.url')\necho $jira\necho $jiraurl\necho $validationresult\necho $validationurl\necho \"##vso[task.setvariable variable=validationresult;]$validationresult\"\necho \"##vso[task.setvariable variable=jira;]$jira\"\necho \"##vso[task.setvariable variable=validationurl;]$validationurl\"\nif [ \"$validationresult\" == \"fail\" ] || [ \"$validationresult\" == \"warning\" ] || [ \"$validationresult\" == \"error\" ]; then\n   echo \"the release validation has failed\"\n   exit 1\nelse\n   echo \"the release validation was successful\"\nfi\n}\n\nstart_validation_wf()\n{\ncreate_token\nres=$(curl -X 'POST' \\\n  \"$(dt_tenant_url)/platform/automation/v1/workflows/$(dt_validation_wf_id_staging)/run\" \\\n  -H 'accept: application/json' \\\n  -H 'Content-Type: application/json' \\\n  -H \"authorization: Bearer $(echo $result_dyna)\" \\\n  -d '{\n         \"params\": {\n            \"Release\": $(Release.ReleaseId),\n            \"PROBLEM\": \"$(PROBLEM)\",\n            \"Pipelineurl\": \"$(Release.ReleaseWebURL)\",\n            \"test_start_timestamp\": \"$(start_timestamp)\",\n            \"test_stop_timestamp\": \"$(stop_timestamp)\",\n            \"stage\": \"$(ENVIRONMENT)\",\n            \"Repository\": \"$(REPOSITORY)\",\n            \"Release_Version\": \"$(DT_RELEASE_VERSION)\",\n            \"Application\": \"$(APPLICATION)\",\n            \"Namespace\": \"$(NAMESPACE)\",\n            \"Build_Version\": \"$(DT_RELEASE_BUILD_VERSION)\"       \n         }\n         }')\nid=$(echo $res | jq -r '.id')\necho $id\nwhile [[ $(get_validation_status) == \"RUNNING\" ]]; do\nsleep 30\ndone\n\n}\n\nstart_test_wf()\n{\ncreate_token\nres=$(curl -X 'POST' \\\n  \"$(dt_tenant_url)/platform/automation/v1/workflows/$(dt_event_wf)/run\" \\\n  -H 'accept: application/json' \\\n  -H 'Content-Type: application/json' \\\n  -H \"authorization: Bearer $(echo $result_dyna)\" \\\n  -d '{\n         \"params\": {\n            \"event_type\": \"END_TEST\",\n            \"PROBLEM\": \"$(PROBLEM)\",\n            \"Release\": $(Release.ReleaseId),\n            \"Pipelineurl\": \"$(Release.ReleaseWebURL)\",\n            \"stage\": \"$(ENVIRONMENT)\",\n            \"Repository\": \"$(REPOSITORY)\",\n            \"Release_Version\": \"$(DT_RELEASE_VERSION)\",\n            \"Application\": \"$(APPLICATION)\",\n            \"Namespace\": \"$(NAMESPACE)\",\n            \"Build_Version\": \"$(DT_RELEASE_BUILD_VERSION)\"            \n         }\n         }')\nid=$(echo $res | jq -r '.id')\necho $id\n#while [[ $(get_wf_status) == \"RUNNING\" ]]; do\n#sleep 10\n#done\n\n}\n\n \nmain()\n{\n  start_test_wf\n  sleep 30\n  start_validation_wf\n  get_result\n   \n}\n\nmain\n","workingDirectory":"","failOnStderr":"false","bashEnvValue":""}},{"environment":{"$dt_clientid":"$(dt_clientid)","$dt_clientsecret":"$(dt_clientsecret)","$dt_tenant_url":"$(dt_tenant_url)","$dt_validation_wf_id":"$(dt_validation_wf_id)"},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Rollback","refName":"","enabled":false,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"failed()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"Deployment_latest() {\ncd $(System.ArtifactsDirectory)/$(Release.PrimaryArtifactSourceAlias)\nkubectl set image -n $(staging_namespace) deployment/transactionhistory transactionhistory=gcr.io/sales-engineering-emea/bank-of-anthos/transactionhistory:latest\nkubectl rollout restart deployment/transactionhistory -n $(staging_namespace)\nkubectl wait --for=condition=available --timeout=300s --all deployments --namespace $(staging_namespace)  || true\n#kubectl delete deployment loadgenerator -n $(staging_namespace) || true\n}\n\nDeployment_latest\necho 'Application has been Rolled Back Successfully'","workingDirectory":"","failOnStderr":"false","bashEnvValue":""}}]}],"environmentOptions":{"emailNotificationType":"OnlyOnFailure","emailRecipients":"release.environment.owner;release.creator","skipArtifactsDownload":false,"timeoutInMinutes":0,"enableAccessToken":false,"publishDeploymentStatus":true,"badgeEnabled":false,"autoLinkWorkItems":false,"pullRequestDeploymentEnabled":false},"demands":[],"conditions":[{"name":"ReleaseStarted","conditionType":1,"value":"","result":null}],"executionPolicy":{"concurrencyCount":1,"queueDepthCount":0},"schedules":[],"currentRelease":{"id":8751,"url":"https://vsrm.dev.azure.com/dynatracedevops/ba7b3ec6-64be-4aaf-a132-35b88b7a0c82/_apis/Release/releases/8751","_links":{}},"retentionPolicy":{"daysToKeep":30,"releasesToKeep":3,"retainBuild":true},"processParameters":{},"properties":{"BoardsEnvironmentType":{"$type":"System.String","$value":"unmapped"},"LinkBoardsWorkItems":{"$type":"System.String","$value":"False"}},"preDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"postDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"environmentTriggers":[],"badgeUrl":"https://vsrm.dev.azure.com/dynatracedevops/_apis/public/Release/badge/ba7b3ec6-64be-4aaf-a132-35b88b7a0c82/4/5"},{"id":6,"name":"Production","rank":2,"owner":{"displayName":"Sergio Hinojosa Jimenez","url":"https://spsprodweu3.vssps.visualstudio.com/Ab3bf8268-3954-45ca-a8ea-6dc9b29d125f/_apis/Identities/7e62c20d-31cc-487b-aff1-9a1bceab6e63","_links":{"avatar":{"href":"https://dev.azure.com/dynatracedevops/_apis/GraphProfile/MemberAvatars/aad.NDU0NmM2ODYtZWVhOC03Yzg2LTkyODQtZTBhZWVmNDZlN2M5"}},"id":"7e62c20d-31cc-487b-aff1-9a1bceab6e63","uniqueName":"sergio.hinojosa@dynatrace.com","imageUrl":"https://dev.azure.com/dynatracedevops/_apis/GraphProfile/MemberAvatars/aad.NDU0NmM2ODYtZWVhOC03Yzg2LTkyODQtZTBhZWVmNDZlN2M5","descriptor":"aad.NDU0NmM2ODYtZWVhOC03Yzg2LTkyODQtZTBhZWVmNDZlN2M5"},"variables":{},"variableGroups":[],"preDeployApprovals":{"approvals":[{"rank":1,"isAutomated":false,"isNotificationOn":false,"approver":{"displayName":"Sergio Hinojosa Jimenez","url":"https://spsprodweu3.vssps.visualstudio.com/Ab3bf8268-3954-45ca-a8ea-6dc9b29d125f/_apis/Identities/7e62c20d-31cc-487b-aff1-9a1bceab6e63","_links":{"avatar":{"href":"https://dev.azure.com/dynatracedevops/_apis/GraphProfile/MemberAvatars/aad.NDU0NmM2ODYtZWVhOC03Yzg2LTkyODQtZTBhZWVmNDZlN2M5"}},"id":"7e62c20d-31cc-487b-aff1-9a1bceab6e63","uniqueName":"sergio.hinojosa@dynatrace.com","imageUrl":"https://dev.azure.com/dynatracedevops/_apis/GraphProfile/MemberAvatars/aad.NDU0NmM2ODYtZWVhOC03Yzg2LTkyODQtZTBhZWVmNDZlN2M5","descriptor":"aad.NDU0NmM2ODYtZWVhOC03Yzg2LTkyODQtZTBhZWVmNDZlN2M5"},"id":16},{"rank":1,"isAutomated":false,"isNotificationOn":false,"approver":{"displayName":"Danny Braaf","url":"https://spsprodweu3.vssps.visualstudio.com/Ab3bf8268-3954-45ca-a8ea-6dc9b29d125f/_apis/Identities/828f251f-4e13-67bb-aa8f-57011c8b421d","_links":{"avatar":{"href":"https://dev.azure.com/dynatracedevops/_apis/GraphProfile/MemberAvatars/aad.ODI4ZjI1MWYtNGUxMy03N2JiLWFhOGYtNTcwMTFjOGI0MjFk"}},"id":"828f251f-4e13-67bb-aa8f-57011c8b421d","uniqueName":"daniel.braaf@dynatrace.com","imageUrl":"https://dev.azure.com/dynatracedevops/_apis/GraphProfile/MemberAvatars/aad.ODI4ZjI1MWYtNGUxMy03N2JiLWFhOGYtNTcwMTFjOGI0MjFk","descriptor":"aad.ODI4ZjI1MWYtNGUxMy03N2JiLWFhOGYtNTcwMTFjOGI0MjFk"},"id":17}],"approvalOptions":{"requiredApproverCount":1,"releaseCreatorCanBeApprover":true,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":1440,"executionOrder":1}},"deployStep":{"id":20},"postDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":21}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":2}},"deployPhases":[{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"agentSpecification":null,"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[]},"queueId":71,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":1,"phaseType":1,"name":"production-deployment","refName":null,"workflowTasks":[{"environment":{},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Deploy Application","refName":"","enabled":false,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"Deployment_latest() {\ncd $(System.ArtifactsDirectory)/$(Release.PrimaryArtifactSourceAlias)\n#kubectl create namespace $(prod_namespace) || true\n#kubectl apply -f ./extras/jwt/jwt-secret.yaml --namespace=$(prod_namespace) \n#kubectl apply -f ./kubernetes-manifests --namespace=$(prod_namespace) \nkubectl set image -n $(prod_namespace) deployment/transactionhistory transactionhistory=gcr.io/sales-engineering-emea/bank-of-anthos/transactionhistory:latest\nkubectl rollout restart deployment/transactionhistory\nkubectl wait --for=condition=available --timeout=300s --all deployments --namespace $(prod_namespace)  || true\nkubectl delete deployment loadgenerator -n $(prod_namespace) || true\n}\n\n\nDeployment_latest","workingDirectory":"","failOnStderr":"false","bashEnvValue":""}},{"environment":{},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Post Prod Deployment Release Validation (Quality)","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"#!/bin/bash\njustdate=$(date '+%Y-%m-%d')\n#major=$(echo $(BUILD.BUILDNUMBER) | cut -d. -f1)\n#minor=$(echo $(BUILD.BUILDNUMBER) | cut -d. -f2)\n#revision=$(echo $(BUILD.BUILDNUMBER) | cut -d. -f3)\n\n\ncreate_token()\n{\nresult=$(curl --request POST 'https://sso.dynatrace.com/sso/oauth2/token' \\\n--header 'Content-Type: application/x-www-form-urlencoded' \\\n--data-urlencode 'grant_type=client_credentials' \\\n--data-urlencode \"client_id=$(dt_clientid)\" \\\n--data-urlencode \"client_secret=$(dt_clientsecret)\" \\\n--data-urlencode 'scope=document:documents:write document:documents:read document:documents:delete document:environment-shares:read document:environment-shares:write document:environment-shares:claim document:environment-shares:delete automation:workflows:read automation:workflows:write automation:workflows:run automation:rules:read automation:rules:write automation:calendars:read automation:calendars:write')\nresult_dyna=$(echo $result | jq -r '.access_token')\n}\n\nget_validation_status()\n{\ncreate_token\ncurl -X 'GET' \\\n  \"$(dt_tenant_url)/platform/automation/v1/executions/$(echo $id)\" \\\n  -H 'accept: application/json' \\\n  -H 'Content-Type: application/json' \\\n  -H \"authorization: Bearer $(echo $result_dyna)\" | jq -r '.state'\n}\n\nget_result()\n{\ncreate_token\nrex=$(curl -X 'GET' \\\n  \"$(dt_tenant_url)/platform/automation/v1/executions/$(echo $id)/tasks\" \\\n  -H 'accept: application/json' \\\n  -H 'Content-Type: application/json' \\\n  -H \"authorization: Bearer $(echo $result_dyna)\") \n#echo $rex\nvalidationresult=$(echo $rex | jq -r '.run_validation.result.validation_status')\nvalidationurl=$(echo $rex | jq -r '.run_validation.result.validation_url')\necho $validationresult\necho $validationurl\necho \"##vso[task.setvariable variable=validationresult;]$validationresult\"\necho \"##vso[task.setvariable variable=validationurl;]$validationurl\"\nif [ \"$validationresult\" == \"fail\" ] || [ \"$validationresult\" == \"warning\" ] || [ \"$validationresult\" == \"error\" ]; then\n   echo \"the release validation has failed\"\n   exit 1\nelse\n   echo \"the release validation was successful\"\nfi\n}\n\nstart_validation_wf()\n{\ncreate_token\nres=$(curl -X 'POST' \\\n  \"$(dt_tenant_url)/platform/automation/v1/workflows/$(dt_validation_wf_id_production)/run\" \\\n  -H 'accept: application/json' \\\n  -H 'Content-Type: application/json' \\\n  -H \"authorization: Bearer $(echo $result_dyna)\")\nid=$(echo $res | jq -r '.id')\necho $id\nwhile [[ $(get_validation_status) == \"RUNNING\" ]]; do\nsleep 90\ndone\n\n}\n\nmain()\n{\n  start_validation_wf\n  get_result\n}\n\nmain","workingDirectory":"","failOnStderr":"false","bashEnvValue":""}},{"environment":{},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Rollback","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"failed()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"# Write your commands here\nsleep 30\necho 'Application has been Rolled Back Successfully'\n","workingDirectory":"","failOnStderr":"false","bashEnvValue":""}}]}],"environmentOptions":{"emailNotificationType":"OnlyOnFailure","emailRecipients":"release.environment.owner;release.creator","skipArtifactsDownload":false,"timeoutInMinutes":0,"enableAccessToken":false,"publishDeploymentStatus":true,"badgeEnabled":false,"autoLinkWorkItems":false,"pullRequestDeploymentEnabled":false},"demands":[],"conditions":[{"name":"Staging","conditionType":2,"value":"4","result":null}],"executionPolicy":{"concurrencyCount":100,"queueDepthCount":0},"schedules":[],"currentRelease":{"id":7150,"url":"https://vsrm.dev.azure.com/dynatracedevops/ba7b3ec6-64be-4aaf-a132-35b88b7a0c82/_apis/Release/releases/7150","_links":{}},"retentionPolicy":{"daysToKeep":30,"releasesToKeep":3,"retainBuild":true},"processParameters":{},"properties":{"BoardsEnvironmentType":{"$type":"System.String","$value":"unmapped"},"LinkBoardsWorkItems":{"$type":"System.String","$value":"False"}},"preDeploymentGates":{"id":0,"gatesOptions":{"isEnabled":false,"timeout":1440,"samplingInterval":15,"stabilizationTime":5,"minimumSuccessDuration":0},"gates":[]},"postDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"environmentTriggers":[],"badgeUrl":"https://vsrm.dev.azure.com/dynatracedevops/_apis/public/Release/badge/ba7b3ec6-64be-4aaf-a132-35b88b7a0c82/4/6"}],"artifacts":[{"sourceId":"7c005439-979c-4f31-8a12-d6599fb1b675:sergiohinojosa/bank-of-anthos","type":"GitHub","alias":"bank-of-anthos","definitionReference":{"artifactSourceDefinitionUrl":{"id":"https://github.com/sergiohinojosa/bank-of-anthos","name":""},"branch":{"id":"feature/azdointegration","name":"feature/azdointegration"},"checkoutNestedSubmodules":{"id":"True","name":"Any nested submodules within"},"checkoutSubmodules":{"id":"","name":""},"connection":{"id":"7c005439-979c-4f31-8a12-d6599fb1b675","name":"GitHub connection anthos"},"defaultVersionSpecific":{"id":"","name":""},"defaultVersionType":{"id":"latestFromBranchType","name":"Latest from the default branch"},"definition":{"id":"sergiohinojosa/bank-of-anthos","name":"sergiohinojosa/bank-of-anthos"},"fetchDepth":{"id":"","name":""},"gitHubRepositoryId":{"id":"723018886","name":"723018886"},"gitLfsSupport":{"id":"","name":""}},"isPrimary":true,"isRetained":false}],"triggers":[{"schedule":{"jobId":"cd4b8216-6dc6-45a2-a33d-91b4b1c75dcb","timeZoneId":"UTC","startHours":0,"startMinutes":0,"daysToRelease":127},"triggerType":2},{"schedule":{"jobId":"83455bde-6f41-4652-b355-9eb418e1697b","timeZoneId":"UTC","startHours":1,"startMinutes":0,"daysToRelease":127},"triggerType":2},{"schedule":{"jobId":"cdc811ec-fc29-4c24-8744-e584713150a8","timeZoneId":"UTC","startHours":2,"startMinutes":0,"daysToRelease":127},"triggerType":2},{"schedule":{"jobId":"86ec48aa-4669-4e6c-b69e-2f6bcde5f436","timeZoneId":"UTC","startHours":3,"startMinutes":0,"daysToRelease":127},"triggerType":2},{"schedule":{"jobId":"f6c8694a-fedb-4625-8a24-cc247cfce4b2","timeZoneId":"UTC","startHours":4,"startMinutes":0,"daysToRelease":127},"triggerType":2},{"schedule":{"jobId":"4fb556dc-2003-4df0-843e-472800e7d4bf","timeZoneId":"UTC","startHours":5,"startMinutes":0,"daysToRelease":127},"triggerType":2},{"schedule":{"jobId":"adffe765-124a-46dc-b6a5-9de07ea3cdf2","timeZoneId":"UTC","startHours":6,"startMinutes":0,"daysToRelease":127},"triggerType":2},{"schedule":{"jobId":"36deaf06-76d4-4937-a6b9-b9f1549450a8","timeZoneId":"UTC","startHours":7,"startMinutes":0,"daysToRelease":127},"triggerType":2},{"schedule":{"jobId":"e55c11cd-6594-4e93-be13-22fb76a55fbf","timeZoneId":"UTC","startHours":8,"startMinutes":0,"daysToRelease":127},"triggerType":2},{"schedule":{"jobId":"77b934ce-1d09-4ffa-9f19-316e0af4962d","timeZoneId":"UTC","startHours":9,"startMinutes":0,"daysToRelease":127},"triggerType":2},{"schedule":{"jobId":"a57330f5-3929-4d5a-9007-4f83a47bca43","timeZoneId":"UTC","startHours":10,"startMinutes":0,"daysToRelease":127},"triggerType":2},{"schedule":{"jobId":"0f7f8236-4f9e-43b3-8c92-3fdb459d5858","timeZoneId":"UTC","startHours":11,"startMinutes":0,"daysToRelease":127},"triggerType":2},{"schedule":{"jobId":"b67b3279-a661-4f3d-a955-b8dd76cebe97","timeZoneId":"UTC","startHours":12,"startMinutes":0,"daysToRelease":127},"triggerType":2},{"schedule":{"jobId":"13d8e20b-cc7b-432f-bc09-b609dbcb780f","timeZoneId":"UTC","startHours":13,"startMinutes":0,"daysToRelease":127},"triggerType":2},{"schedule":{"jobId":"b3e7eab4-85e8-40ff-b888-7437fb56a925","timeZoneId":"UTC","startHours":14,"startMinutes":0,"daysToRelease":127},"triggerType":2},{"schedule":{"jobId":"6e4af43c-20b9-4523-b0e0-56ae9510503e","timeZoneId":"UTC","startHours":15,"startMinutes":0,"daysToRelease":127},"triggerType":2},{"schedule":{"jobId":"faada75e-6875-445c-9209-75facd008e13","timeZoneId":"UTC","startHours":16,"startMinutes":0,"daysToRelease":127},"triggerType":2},{"schedule":{"jobId":"2b91eeb8-f72b-47b7-982a-59dcefecc0ef","timeZoneId":"UTC","startHours":17,"startMinutes":0,"daysToRelease":127},"triggerType":2},{"schedule":{"jobId":"a7ac4296-3792-40bc-85e9-54a3e14de2b7","timeZoneId":"UTC","startHours":18,"startMinutes":0,"daysToRelease":127},"triggerType":2},{"schedule":{"jobId":"1eb45c1d-ca32-4fdb-b259-0884d569d1a3","timeZoneId":"UTC","startHours":19,"startMinutes":0,"daysToRelease":127},"triggerType":2},{"schedule":{"jobId":"e7c85617-5a60-47a9-9891-f652893ba2fe","timeZoneId":"UTC","startHours":20,"startMinutes":0,"daysToRelease":127},"triggerType":2},{"schedule":{"jobId":"82bf6519-4c1d-45f4-ad4d-0dd721c6420e","timeZoneId":"UTC","startHours":21,"startMinutes":0,"daysToRelease":127},"triggerType":2},{"schedule":{"jobId":"9c94be16-7384-422e-959a-6b3c0098e3e7","timeZoneId":"UTC","startHours":22,"startMinutes":0,"daysToRelease":127},"triggerType":2},{"schedule":{"jobId":"c2d428d5-17b8-46e2-bdc1-ad89d3223286","timeZoneId":"UTC","startHours":23,"startMinutes":0,"daysToRelease":127},"triggerType":2}],"releaseNameFormat":"Release-$(rev:r)","tags":[],"properties":{"DefinitionCreationSource":{"$type":"System.String","$value":"ReleaseImport"},"IntegrateBoardsWorkItems":{"$type":"System.String","$value":"False"},"IntegrateJiraWorkItems":{"$type":"System.String","$value":"false"}},"id":4,"name":"bank-of-anthos","path":"\\","projectReference":null,"url":"https://vsrm.dev.azure.com/dynatracedevops/ba7b3ec6-64be-4aaf-a132-35b88b7a0c82/_apis/Release/definitions/4","_links":{"self":{"href":"https://vsrm.dev.azure.com/dynatracedevops/ba7b3ec6-64be-4aaf-a132-35b88b7a0c82/_apis/Release/definitions/4"},"web":{"href":"https://dev.azure.com/dynatracedevops/ba7b3ec6-64be-4aaf-a132-35b88b7a0c82/_release?definitionId=4"}}}